{% extends "base/base.html" %}
{% load staticfiles %}
{% load bootstrap %}
{% load json_filters %}

{% block css %}
    {{ block.super }}
    <style>
        .percent-result {
            font-size: 40px;
        }

        .vis-item.green {
            background-color: {{ COLOR_GREEN }};
            border-color: {{ COLOR_GREEN }};
        }

        .vis-item.orange {
            background-color: {{ COLOR_ORANGE }};
            border-color: {{ COLOR_ORANGE }};
        }

        .vis-item.red {
            background-color: {{ COLOR_RED }};
            border-color: {{ COLOR_RED }};
        }

        .vis-item.window-event {
            background-color: {{ COLOR_BLUE }};
            border-color: {{ COLOR_BLUE }};
        }
    </style>
{% endblock %}


{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <ol class="breadcrumb">
                    <li><a href="{% url "base:dashboard" %}">home</a></li>
                    <li><a href="{% url "analytics:view_case" case.id %}">caso</a></li>
                    <li class="active">resultados</li>
                </ol>

                <h3>
                    Reporte
                            <span class="pull-right">
                                Estado del caso
                                <span class="label label-{% if case.status == case.STATUS_OPEN %}success{% else %}danger{% endif %}">{{ case.get_status_display }}</span>
                            </span>
                </h3>
                <hr>
                <form method="post" action="" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 col-xs-12">
                            <svg id="atm-index-chart" style="width: 100%; height: 250px; margin: 0 auto"></svg>
                        </div>
                        <div class="col-md-6 col-xs-12">
                            <svg id="total-operations-report-chart"
                                 style="width: 100%; height: 250px; margin: 0 auto"></svg>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-4 col-xs-12">
                            <h4>Errores Criticos</h4>
                            <svg id="critical-errors-chart"
                                 style="width: 100%; height: 240px; margin: 0 auto"></svg>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h4>Errores Importantes</h4>
                            <svg id="important-errors-chart"
                                 style="width: 100%; height: 240px; margin: 0 auto"></svg>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h4>Transacciones sin problemas</h4>
                            <svg id="no-errors-chart" style="width: 100%; height: 240px; margin: 0 auto"></svg>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <h3>Reporte de Operaciones</h3>
                        <svg id="operations-report-chart"
                             style="width: 100%; height: 300px; margin: 0 auto"></svg>

                    </div>
                    <hr>
                    <div class="row">
                        <svg id="errors-report-chart"
                             style="width: 100%; height: 300px; margin: 0 auto"></svg>

                    </div>
                    <hr>
                    <div class="panel panel-primary row">
                        <div class="panel-heading">
                            <h3 class="panel-title">Operaciones</h3>
                            <div class="pull-right">
                                <span class="clickable filter"
                                      data-toggle="tooltip"
                                      title="Filtro de tabla"
                                      data-container="body">
                                    <i class="glyphicon glyphicon-filter"></i>
                                </span>
                            </div>
                        </div>
                        <div class="panel-body">
                            <input type="text" class="form-control" id="operations-table-filter"
                                   data-action="filter"
                                   data-filters="#operations-table" placeholder="Filtar operaciones"/>
                        </div>
                        <table class="table table-hover" id="operations-table">
                            <thead>
                            <tr>
                                <th>Selector</th>
                                <th>Fecha</th>
                                <th>Error</th>
                                <th>Monto</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <hr>
                    <div class="row">
                        <h3>Timeline</h3>
                        <div class="form-inline">
                            <div class="form-group">
                                <div class="btn-group text-center" data-toggle="buttons">
                                    <label class="btn btn-primary active">
                                        <input id="timeline-filter-critical-erros" type="checkbox" autocomplete="off"
                                               checked> Error critico
                                    </label>
                                    <label class="btn btn-primary active">
                                        <input id="timeline-filter-important-erros" type="checkbox" autocomplete="off"
                                               checked> Error importante
                                    </label>
                                    <label class="btn btn-primary active">
                                        <input id="timeline-filter-no-erros" type="checkbox" autocomplete="off" checked>
                                        Sin
                                        errores
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="input-group">
                                    <div class="input-group-addon"><span class="glyphicon glyphicon-calendar"
                                                                         aria-hidden="true"></span></div>
                                    <input size="23" type="text" id="timeline-calendar-picker" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <select id="timeline-filter-errors" class="form-control" multiple="multiple">
                                    <option value="all" selected>Todos</option>
                                </select>
                            </div>
                        </div>
                        <br>
                        <div id="chart-events-timeline" style="width: 100%; margin: 0 auto"></div>
                    </div>
                    <hr>
                    <div class="panel panel-primary row">
                        <div class="panel-heading">
                            <h3 class="panel-title">Timeline</h3>
                            <div class="pull-right">
                                <span data-toggle="tooltip"
                                      title="Filtro de tabla"
                                      data-container="body">
                                    <i class="glyphicon glyphicon-filter"></i>
                                </span>
                            </div>
                        </div>
                        <div class="panel-body">
                            <input type="text" class="form-control" id="timeline-table-filter"
                                   data-action="filter"
                                   data-filters="#timeline-table" placeholder="Filtar timeline"/>
                        </div>
                        <table class="table table-hover" id="timeline-table">
                            <thead>
                            <tr>
                                <th>Selector</th>
                                <th>Fecha</th>
                                <th>Error</th>
                                <th>Monto</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <hr>
                    <div class="row">
                        <h3>Análisis Automático</h3>
                        <div class="col-md-4 col-xs-12">
                            <h5>Logs Journal
                                <a href="javascript: void (0)" data-toggle="popover"
                                   data-placement="left" data-html="true"
                                   data-trigger="focus" title="Title"
                                   data-content="Body">
                                    <i class="fa fa-question-circle"></i>
                                </a>
                            </h5>

                            <div class="well percent-result text-center">33%</div>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h5>Logs Windows
                                <a href="javascript: void (0)" data-toggle="popover"
                                   data-placement="left" data-html="true"
                                   data-trigger="focus" title="Title"
                                   data-content="Body">
                                    <i class="fa fa-question-circle"></i>
                                </a>
                            </h5>
                            <div class="well percent-result text-center">100%</div>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h5>Estimación del caso
                                <a href="javascript: void (0)" data-toggle="popover"
                                   data-placement="left" data-html="true"
                                   data-trigger="focus" title="Title"
                                   data-content="Body">
                                    <i class="fa fa-question-circle"></i>
                                </a>
                            </h5>
                            <div class="well percent-result text-center">98%</div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <h3>Análisis del Caso</h3>
                        <p><b>Nombre:</b> {{ case.name }}</p>
                        <p><b>ID:</b> {{ case.id }}</p>
                        <p><b>Monto Faltante:</b> {{ case.missing_amount }}</p>
                        <p><b>Cantidad de ATMs afectados:</b> {{ case.atms.count }}</p>
                        <p><b>Fecha:</b> {{ case.created_date }}</p>
                        <p><b>Cliente:</b> {{ case.bank }}</p>
                        <p><b>Resolución:</b></p>
                        <div class="form-group {% if form.resolution.errors %}has-error{% endif %}">
                            {% if form.resolution.help_text %}
                                <span class="help-block">{{ form.resolution.help_text }}</span>
                            {% endif %}
                            {% if form.resolution.errors %}
                                <span class="help-block">{{ form.resolution.errors|join:"<br \>" }}</span>
                            {% endif %}
                            {{ form.resolution|add_class:"form-control" }}
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="form-group">
                            {% if case.status == case.STATUS_OPEN %}
                                <input class="btn btn-default btn-lg pull-left" name="close-status"
                                       type="submit"
                                       value="Cerrar"/>
                            {% else %}
                                <input class="btn btn-default btn-lg pull-left" name="open-status" type="submit"
                                       value="Abrir"/>
                            {% endif %}

                            <input class="btn btn-default btn-lg pull-right" name="save" type="submit"
                                   value="Guardar" style="margin-left: 20px"/>
                            <a href="javascript: void(0)" class="btn btn-default btn-lg pull-right">PDF</a>
                            <br>
                            <br>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>
{% endblock content %}

{% block js %}
    {{ block.super }}
    <script>
        $(function () {
            // init popover (help text)
            $("[data-toggle=popover]").popover();

            var journalData = {{ journal_traces | jsonify }};
            var eventViewerData = {{ event_viewer_traces | jsonify }};
            var errorsMeta = {{ errors | jsonify }};
            var transformed = {};

            errorsMeta.names = _.map(errorsMeta.names, function (item) {
                return {id: item, text: item};
            });

            var atmIndexChart = dc.pieChart("#atm-index-chart");
            var errorsReportChart = dc.pieChart("#errors-report-chart");
            var criticalErrorsChart = dc.barChart("#critical-errors-chart");
            var importantErrorsChart = dc.barChart("#important-errors-chart");
            var noErrorsChart = dc.barChart("#no-errors-chart");
            var operationsReportChart = dc.barChart("#operations-report-chart");
            var totalOperationsReportChart = dc.pieChart("#total-operations-report-chart");
            var dataTable = dc.dataTable("#operations-table");

            var dtgFormat = d3.time.format("%d/%m/%Y %H:%M:%S");

            _.map(journalData, function (d) {
                d.date = dtgFormat.parse(d.date);
                var amount = d.amount.match(/\d/g);
                d.amount = amount != null ? +amount.join("") : 0;
                d.start = d.date;
                d.printedErrors = d.errors.join(", ");
                d.content = d.has_errors ? d.errors : 'Sin errores';
                transformed[d.date] = d;
            });

            _.map(eventViewerData, function (d) {
                d.date = dtgFormat.parse(d.date);
                d.start = d.date;
                d.content = d.record_id;
            });

            // CROSSFILTER ******************************************************
            var ndx = crossfilter(journalData);

            // Dimensions and groups
            var atmsDim = ndx.dimension(function (d) {
                return d.atm_index;
            });
            var countATMsIndex = atmsDim.group().reduceCount(function (d) {
                return d.atm_index;
            });

            var dateDim = ndx.dimension(function (d) {
                return d.date;
            });
            // range for x axis. Get the min and max date value in data
            var minDate = dateDim.bottom(1)[0].date;
            var maxDate = dateDim.top(1)[0].date;

            var amountGroupCriticalErrors = dateDim.group().reduceSum(function (d) {
                if (d.color == "{{ COLOR_RED }}") {
                    return d.amount;
                }
            });

            var amountGroupImportantErrors = dateDim.group().reduceSum(function (d) {
                if (d.color == "{{ COLOR_ORANGE }}") {
                    return d.amount;
                }
            });

            var amountGroupNoErrors = dateDim.group().reduceSum(function (d) {
                if (d.color == "{{ COLOR_GREEN }}") {
                    return d.amount;
                }
            });

            var typeDim = ndx.dimension(function (d) {
                return d.event_type;
            });

            var typeErrorsGroupCount = typeDim.group().reduceCount(function (d) {
                return d;
            });

            var printedErrorsDim = ndx.dimension(function (d) {
                return d.printedErrors;
            });
            var printedErrorsGroupCount = printedErrorsDim.group().reduceCount(function (d) {
                return d;
            });

            var amount = dateDim.group().reduceSum(function (d) {
                return d.amount;
            });

            // TABLES *****************************************************
            var operationTable = $("#operations-table").DataTable({
                "language": {
                    "sProcessing": "Procesando...",
                    "sLengthMenu": "Mostrar _MENU_ registros",
                    "sZeroRecords": "No se encontraron resultados",
                    "sEmptyTable": "Ningún dato disponible en esta tabla",
                    "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "sInfoPostFix": "",
                    "sSearch": "Buscar:",
                    "sUrl": "",
                    "sInfoThousands": ",",
                    "sLoadingRecords": "Cargando...",
                    "oPaginate": {
                        "sFirst": "Primero",
                        "sLast": "Último",
                        "sNext": "Siguiente",
                        "sPrevious": "Anterior"
                    },
                    "oAria": {
                        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                    }
                }
            });
            $('#operations-table-filter').keyup(function () {
                operationTable.search($(this).val()).draw();
            });

            var timelineTable = $("#timeline-table").DataTable({
                "language": {
                    "sProcessing": "Procesando...",
                    "sLengthMenu": "Mostrar _MENU_ registros",
                    "sZeroRecords": "No se encontraron resultados",
                    "sEmptyTable": "Ningún dato disponible en esta tabla",
                    "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "sInfoPostFix": "",
                    "sSearch": "Buscar:",
                    "sUrl": "",
                    "sInfoThousands": ",",
                    "sLoadingRecords": "Cargando...",
                    "oPaginate": {
                        "sFirst": "Primero",
                        "sLast": "Último",
                        "sNext": "Siguiente",
                        "sPrevious": "Anterior"
                    },
                    "oAria": {
                        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                    }
                }
            });
            $('#timeline-table-filter').keyup(function () {
                operationTable.search($(this).val()).draw();
            });

            // CHARTS ***********************************************************
            // TIMELINE *********************************************************
            window.timelineData = journalData;
            {#            console.log(eventViewerData.length);#}
            {#            window.timelineData = eventViewerData.slice(0, eventViewerData.length / 2);#}
            {#            console.log(window.timelineData);#}

            function fillTimelineTable(items) {
                timelineTable.clear();
                _.each(items, function (item) {
                    timelineTable.row.add(["<input type='checkbox'></td>", item.date, item.errors, item.amount]);
                });
                timelineTable.draw();
            }

            var timelineContainer = document.getElementById('chart-events-timeline');
            var options = {
                max: maxDate,
                min: minDate
            };
            var timeline = new vis.Timeline(timelineContainer, window.timelineData, options);
            fillTimelineTable(window.timelineData);
            timeline.on("rangechanged", function (properties) {
                var tableData = [];
                _.each(this.getVisibleItems(), function (id) {
                    var itemID = _.filter(window.timelineData, function (item) {
                        return item.id == id;
                    });
                    tableData.push(itemID[0]);
                });
                fillTimelineTable(_.sortBy(tableData, 'date'));
            });

            function filterTimeline(items) {
                var startDate = $('#timeline-calendar-picker').data('daterangepicker').startDate._d;
                var endDate = $('#timeline-calendar-picker').data('daterangepicker').endDate._d;

                // filter dates
                items = _.filter(items, function (item) {
                    return item.date >= startDate && item.date <= endDate;
                });

                // filter by errors
                var selectedErrors = $("#timeline-filter-errors").val();
                if (selectedErrors[0] != "all") {
                    items = _.filter(items, function (item) {
                        return _.intersection(item.errors, selectedErrors).length > 0;
                    });
                }

                // filter critical errors
                if (!$("#timeline-filter-critical-erros").is(":checked")) {
                    items = _.filter(items, function (item) {
                        return item.color != "{{ COLOR_RED }}";
                    });
                }

                // filter important errors
                if (!$("#timeline-filter-important-erros").is(":checked")) {
                    items = _.filter(items, function (item) {
                        return item.color != "{{ COLOR_ORANGE }}";
                    });
                }

                // filter no errors
                if (!$("#timeline-filter-no-erros").is(":checked")) {
                    items = _.filter(items, function (item) {
                        return item.color != "{{ COLOR_GREEN }}";
                    });
                }

                timeline.setItems(items);
                timeline.fit();
                fillTimelineTable(items);
            }

            // init timeline calendar
            $("#timeline-calendar-picker").daterangepicker({
                "timePicker": true,
                "timePicker24Hour": true,
                "timePickerSeconds": true,
                "locale": {
                    "format": "DD/MM/YYYY",
                    "separator": " / "
                },
                "alwaysShowCalendars": true,
                "startDate": minDate,
                "endDate": maxDate,
                "minDate": minDate,
                "maxDate": maxDate
            }, function (start, end, label) {
                filterTimeline(window.timelineData)
            });

            // init errors filter
            $("#timeline-filter-errors").select2({
                data: errorsMeta.names
            });
            $("#timeline-filter-errors").change(function (evt) {
                if ($("#timeline-filter-errors").val() != "all") {
                    filterTimeline(window.timelineData);
                }
            });
            $("#timeline-filter-errors").on("select2:select", function (evt) {
                var selectedErrors = $("#timeline-filter-errors").val();
                if(evt.params.data.id != "all" && selectedErrors[0] == "all"){
                    $("#timeline-filter-errors").val(selectedErrors.slice(1, selectedErrors.length)).change();
                } else if(evt.params.data.id == "all"){
                    $("#timeline-filter-errors").val(["all"]).change();
                }
            });

            $("#timeline-filter-critical-erros").change(function (evt) {
                filterTimeline(window.timelineData);
            });
            $("#timeline-filter-important-erros").change(function (evt) {
                filterTimeline(window.timelineData);
            });
            $("#timeline-filter-no-erros").change(function (evt) {
                filterTimeline(window.timelineData);
            });

            // CROSSFILTER ******************************************************
            atmIndexChart
                    .height(250)
                    .dimension(atmsDim)
                    .group(countATMsIndex)
                    .transitionDuration(100)
                    .on('pretransition', function (chart) {
                        chart.selectAll('text.pie-slice').text(function (d) {
                            var percentage = dc.utils.printSingleValue((d.endAngle - d.startAngle) / (2 * Math.PI) * 100);
                            percentage = Number(percentage).toFixed(1);
                            return "ATM" + (+d.data.key + 1) + ': ' + percentage + '%';
                        })
                    });
            atmIndexChart.on("filtered", function (chart, filter) {
                window.timelineData = atmsDim.top(Infinity);
                timeline.setItems(window.timelineData);
                timeline.fit();
                fillTimelineTable(window.timelineData);
                filterTimeline(window.timelineData);
            });

            totalOperationsReportChart
                    .dimension(typeDim)
                    .group(typeErrorsGroupCount)
                    .innerRadius(30)
                    .transitionDuration(100)
                    .on('pretransition', function (chart) {
                        chart.selectAll('text.pie-slice').text(function (d) {
                            var percentage = dc.utils.printSingleValue((d.endAngle - d.startAngle) / (2 * Math.PI) * 100);
                            percentage = Number(percentage).toFixed(0);
                            return d.data.key + ' ' + percentage + '%';
                        })
                    });
            totalOperationsReportChart.ordinalColors(["{{ COLOR_RED }}", "{{ COLOR_ORANGE }}", "{{ COLOR_GREEN }}"]);

            criticalErrorsChart
                    .margins({top: 10, right: 10, bottom: 30, left: 50})
                    .dimension(dateDim)
                    .group(amountGroupCriticalErrors)
                    .mouseZoomable(true)
                    .brushOn(false)
                    .transitionDuration(100)
                    .centerBar(true)
                    .gap(65)
                    .x(d3.time.scale().domain([minDate, maxDate]))
                    .elasticY(true)
                    .xAxis().tickFormat();
            criticalErrorsChart.on("renderlet", function (chart) {
                chart.selectAll('rect.bar').each(function (d) {
                    d3.select(this).attr("style", "fill: {{ COLOR_RED }}");
                });
            });

            importantErrorsChart
                    .margins({top: 10, right: 10, bottom: 30, left: 50})
                    .dimension(dateDim)
                    .group(amountGroupImportantErrors)
                    .mouseZoomable(true)
                    .brushOn(false)
                    .transitionDuration(100)
                    .centerBar(true)
                    .gap(65)
                    .x(d3.time.scale().domain([minDate, maxDate]))
                    .elasticY(true)
                    .xAxis().tickFormat();
            importantErrorsChart.on("renderlet", function (chart) {
                chart.selectAll('rect.bar').each(function (d) {
                    d3.select(this).attr("style", "fill: {{ COLOR_ORANGE }}");
                });
            });

            noErrorsChart
                    .margins({top: 10, right: 10, bottom: 30, left: 50})
                    .dimension(dateDim)
                    .group(amountGroupNoErrors)
                    .mouseZoomable(true)
                    .brushOn(false)
                    .transitionDuration(100)
                    .centerBar(true)
                    .gap(65)
                    .x(d3.time.scale().domain([minDate, maxDate]))
                    .elasticY(true)
                    .xAxis().tickFormat();
            noErrorsChart.on("renderlet", function (chart) {
                chart.selectAll('rect.bar').each(function (d) {
                    d3.select(this).attr("style", "fill: {{ COLOR_GREEN }}");
                });
            });

            operationsReportChart
                    .margins({top: 10, right: 10, bottom: 30, left: 50})
                    .dimension(dateDim)
                    .group(amount)
                    .mouseZoomable(true)
                    .brushOn(false)
                    .transitionDuration(100)
                    .x(d3.time.scale().domain([minDate, maxDate]));
            operationsReportChart
                    .colors(d3.scale.ordinal().domain(["red", "orange", "green"]).range(["{{ COLOR_RED }}", "{{ COLOR_ORANGE }}", "{{ COLOR_GREEN }}"]))
                    .colorAccessor(function (d) {
                        if (transformed[d.key].color == "{{ COLOR_RED }}") {
                            return "red"
                        } else if (transformed[d.key].color == "{{ COLOR_ORANGE }}") {
                            return "orange"
                        } else if (transformed[d.key].color == "{{ COLOR_GREEN }}") {
                            return "green"
                        }
                    });

            errorsReportChart
                    .dimension(printedErrorsDim)
                    .group(printedErrorsGroupCount)
                    .renderLabel(false)
                    .legend(dc.legend());

            dataTable
                    .dimension(dateDim)
                    .group(function (d) {
                        return ""
                    })
                    .showGroups(false)
                    .columns([
                        function (d) {
                            return '<input type="checkbox"></td>'
                        },
                        function (d) {
                            return d.date;
                        },
                        function (d) {
                            return d.errors;
                        },
                        function (d) {
                            return d.amount;
                        }
                    ])
                    .sortBy(function (d) {
                        return d.date;
                    })
                    .order(d3.ascending);

            dc.renderAll();
        })
    </script>
{% endblock %}
