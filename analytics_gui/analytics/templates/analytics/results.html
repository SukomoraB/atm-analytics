{% extends "base/base.html" %}
{% load staticfiles %}
{% load bootstrap %}
{% load widget_tweaks %}

{% block css %}
    {{ block.super }}
    <style>
        .zoom {
            fill: transparent;
            cursor: pointer;
        }

        .y-axis g line {
            stroke: grey;
            fill: none;
            stroke-width: 1px;
        }

        .graph-body .line {
            height: 20px;
            padding: 10px;
        }

        .percent-result {
            font-size: 40px;
        }
    </style>
{% endblock %}


{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <ol class="breadcrumb">
                    <li><a href="{% url "base:dashboard" %}">home</a></li>
                    <li><a href="{% url "analytics:view_case" case.id %}">caso</a></li>
                    <li class="active">resultados</li>
                </ol>
                <h3>
                    Reporte
                    <span class="pull-right">
                        Estado del caso
                        <span class="label label-{% if case.status == case.STATUS_OPEN %}success{% else %}danger{% endif %}">{{ case.get_status_display }}</span>
                    </span>

                </h3>
                <br>
                <form method="post" action="" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="col-md-4 col-xs-12">
                        <h4>Errores Criticos</h4>
                        <svg id="chart-critical-errors" style="width: 100%; height: 300px; margin: 0 auto"></svg>
                    </div>
                    <div class="col-md-4 col-xs-12">
                        <h4>Errores Importantes</h4>
                        <svg id="chart-important-errors" style="width: 100%; height: 300px; margin: 0 auto"></svg>
                    </div>
                    <div class="col-md-4 col-xs-12">
                        <h4>Transacciones sin problemas</h4>
                        <svg id="chart-no-problem" style="width: 100%; height: 300px; margin: 0 auto"></svg>
                    </div>
                    <h3>Reporte de Operaciones</h3>
                    <svg id="chart-operations-report" style="width: 100%; height: 400px; margin: 0 auto"></svg>
                    <br><br>
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <h3 class="panel-title">Errores</h3>
                            <div class="pull-right">
                            <span class="clickable filter" data-toggle="tooltip" title="Filtro de tabla"
                                  data-container="body">
                                <i class="glyphicon glyphicon-filter"></i>
                            </span>
                            </div>
                        </div>
                        <div class="panel-body">
                            <input type="text" class="form-control" id="error-table-filter" data-action="filter"
                                   data-filters="#error-table" placeholder="Filtar errores"/>
                        </div>
                        <table class="table table-hover" id="error-table">
                            <thead>
                            <tr>
                                <th>Selector</th>
                                <th>Fecha</th>
                                <th>Error</th>
                                <th>Monto</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td><input type="checkbox"></td>
                                <td>2013-06-02</td>
                                <td>Fallo foo</td>
                                <td>10 usd</td>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="checkbox"></td>
                                <td>2013-06-03</td>
                                <td>Fallo faa</td>
                                <td>300 usd</td>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="checkbox"></td>
                                <td>2013-06-04</td>
                                <td>Fallo fii</td>
                                <td>150 usd</td>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="checkbox"></td>
                                <td>2013-06-05</td>
                                <td>Fallo fuu</td>
                                <td>200 usd</td>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <br>

                    <h3>Reporte Cronológico Multiples logs</h3>
                    <svg id="chart-events" style="width: 100%; height: 220px; margin: 0 auto"></svg>
                    <div class="text-center">
                        {% for atm in atms %}
                            <input type="checkbox" checked> ATM {{ forloop.counter }}
                        {% endfor %}
                    </div>


                    <h3>Análisis Automático</h3>
                    <div class="col-md-4 col-xs-12">
                        <h5>Logs Journal
                            <a href="javascript: void (0)" data-toggle="popover"
                               data-placement="left" data-html="true"
                               data-trigger="focus" title="Title"
                               data-content="Body">
                                <i class="fa fa-question-circle"></i>
                            </a>
                        </h5>

                        <div class="well percent-result text-center">33%</div>
                    </div>
                    <div class="col-md-4 col-xs-12">
                        <h5>Logs Windows
                            <a href="javascript: void (0)" data-toggle="popover"
                               data-placement="left" data-html="true"
                               data-trigger="focus" title="Title"
                               data-content="Body">
                                <i class="fa fa-question-circle"></i>
                            </a>
                        </h5>
                        <div class="well percent-result text-center">100%</div>
                    </div>
                    <div class="col-md-4 col-xs-12">
                        <h5>Estimación del caso
                            <a href="javascript: void (0)" data-toggle="popover"
                               data-placement="left" data-html="true"
                               data-trigger="focus" title="Title"
                               data-content="Body">
                                <i class="fa fa-question-circle"></i>
                            </a>
                        </h5>
                        <div class="well percent-result text-center">98%</div>
                    </div>

                    <h3>Análisis del Caso</h3>
                    <p><b>Nombre:</b> {{ case.name }}</p>
                    <p><b>ID:</b> {{ case.id }}</p>
                    <p><b>Monto Faltante:</b> {{ case.missing_amount }}</p>
                    <p><b>Cantidad de ATMs afectados:</b> {{ case.atms.count }}</p>
                    <p><b>Fecha:</b> {{ case.created_date }}</p>
                    <p><b>Cliente:</b> {{ case.bank }}</p>
                    <p><b>Resolución:</b></p>
                    <div class="form-group {% if form.resolution.errors %}has-error{% endif %}">
                        {% if form.resolution.help_text %}
                            <span class="help-block">{{ form.resolution.help_text }}</span>
                        {% endif %}
                        {% if form.resolution.errors %}
                            <span class="help-block">{{ form.resolution.errors|join:"<br \>" }}</span>
                        {% endif %}
                        {{ form.resolution|add_class:"form-control" }}
                    </div>

                    <div class="form-group">
                        <input class="btn btn-default btn-lg pull-left" name="close" type="submit"
                               value="Cerrar"/>
                        <input class="btn btn-default btn-lg pull-right" name="save" type="submit"
                               value="Guardar" style="margin-left: 20px"/>
                        <a id="generate-pdf" href="#" class="btn btn-default btn-lg pull-right">PDF</a>
                        <br>
                        <br>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>
{% endblock content %}

{% block js %}
    {{ block.super }}
    <script type="text/javascript" src="{% static "data/fakeData.js" %}"></script>
    <script>
        $(function () {
            // init popover (help text)
            $("[data-toggle=popover]").popover();

            var chartsCount = Number("{{ atms.count }}"),
                    color = d3.scale.category20(),
                    chartOptions = {
                        axis: {
                            x: {
                                type: 'timeseries',
                                tick: {
                                    format: '%Y-%m-%d'
                                }
                            }
                        },
                        data: {
                            type: 'bar',
                            x: 'x'
                        },
                        legend: {
                            show: false
                        },
                        zoom: {
                            enabled: true
                        }
                    };

            // AREA CHART *****************************************************
            var chartCriticalErrorsOptions = _.extend(chartOptions, {bindto: '#chart-critical-errors'});
            chartCriticalErrorsOptions.data['columns'] = [
                ['x', Date.UTC(2013, 5, 2), Date.UTC(2013, 5, 3), Date.UTC(2013, 5, 4), Date.UTC(2013, 5, 5), Date.UTC(2013, 5, 6), Date.UTC(2013, 5, 7)],
                ['data', 30, 200, 100, 400, 150, 250]
            ];
            chartCriticalErrorsOptions.data['colors'] = {data: '#ff0000'};
            var chartCriticalErrors = c3.generate(chartCriticalErrorsOptions);

            var chartImportantErrorsOptions = _.extend(chartOptions, {bindto: '#chart-important-errors'});
            chartImportantErrorsOptions.data['columns'] = [
                ['x', Date.UTC(2013, 5, 2), Date.UTC(2013, 5, 3), Date.UTC(2013, 5, 4), Date.UTC(2013, 5, 5), Date.UTC(2013, 5, 6), Date.UTC(2013, 5, 7)],
                ['data', 130, 340, 200, 500, 250, 20]
            ];
            chartImportantErrorsOptions.data['colors'] = {data: '#FF9300'};
            var chartImportantErrors = c3.generate(chartImportantErrorsOptions);

            var chartNoProblemOptions = _.extend(chartOptions, {bindto: '#chart-no-problem'});
            chartNoProblemOptions.data['columns'] = [
                ['x', Date.UTC(2013, 5, 2), Date.UTC(2013, 5, 3), Date.UTC(2013, 5, 4), Date.UTC(2013, 5, 5), Date.UTC(2013, 5, 6), Date.UTC(2013, 5, 7)],
                ['data', 51, 43, 12, 500, 230, 150]
            ];
            chartNoProblemOptions.data['colors'] = {data: '#008000'};
            var chartNoProblem = c3.generate(chartNoProblemOptions);


            var chart = c3.generate({
                bindto: '#chart-operations-report',
                axis: {
                    x: {
                        type: 'timeseries',
                        tick: {
                            format: '%Y-%m-%d'
                        }
                    }
                },
                data: {
                    type: 'bar',
                    x: 'x',
                    columns: [
                        ['x', Date.UTC(2013, 5, 2), Date.UTC(2013, 5, 3), Date.UTC(2013, 5, 4), Date.UTC(2013, 5, 5), Date.UTC(2013, 5, 6), Date.UTC(2013, 5, 7)],
                        ['data1', 30, 200, 200, 400, 150, 250],
                        ['data2', 130, 100, 100, 200, 150, 50],
                        ['data3', 230, 200, 200, 300, 250, 250]
                    ],
                    groups: [
                        ['data1', 'data2', 'data3']
                    ],
                    colors: {
                        data1: '#ff0000',
                        data2: '#FF9300',
                        data3: '#008000'
                    },
                    names: {
                        data1: 'Errores Criticos',
                        data2: 'Errores Importantes',
                        data3: 'Transacciones sin problemas'
                    }
                },
                zoom: {
                    enabled: true
                }
            });

            // EVENTS GRAPH *****************************************************
            // create 10 events
            var eventsData = [];
            for (var i = 0; i < chartsCount; i++) {
                eventsData.push(createEvent("ATM " + (i + 1) + " XFS"));
                eventsData.push(createEvent("ATM " + (i + 1) + " Microsoft"));
            }

            var eventDropsChart = d3.chart.eventDrops()
                    .eventLineColor(function (datum, index) {
                        return color(index);
                    })
                    .start(new Date(startTime))
                    .end(new Date(endTime));

            d3.select('#chart-events')
                    .datum(eventsData)
                    .call(eventDropsChart);

            // TABLES *****************************************************
            var oTable = $("#error-table").DataTable({
                "language": {
                    "sProcessing": "Procesando...",
                    "sLengthMenu": "Mostrar _MENU_ registros",
                    "sZeroRecords": "No se encontraron resultados",
                    "sEmptyTable": "Ningún dato disponible en esta tabla",
                    "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "sInfoPostFix": "",
                    "sSearch": "Buscar:",
                    "sUrl": "",
                    "sInfoThousands": ",",
                    "sLoadingRecords": "Cargando...",
                    "oPaginate": {
                        "sFirst": "Primero",
                        "sLast": "Último",
                        "sNext": "Siguiente",
                        "sPrevious": "Anterior"
                    },
                    "oAria": {
                        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                    }
                }
            });
            $('#error-table-filter').keyup(function () {
                oTable.search($(this).val()).draw();
            });

        })
    </script>
    <script type="text/javascript" src="{% static "js/svgAsBase64.js" %}"></script>
    <script type="text/javascript" src="{% static "js/generatePdf.js" %}"></script>
{% endblock %}
