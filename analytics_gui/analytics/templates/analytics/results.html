{% extends "base/base.html" %}
{% load staticfiles %}

{% block css %}
    {{ block.super }}
    <style>
        .zoom {
            fill: transparent;
            cursor: pointer;
        }

        .y-axis g line {
            stroke: grey;
            fill: none;
            stroke-width: 1px;
        }

        .graph-body .line {
            height: 20px;
            padding: 10px;
        }
    </style>
{% endblock %}


{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <ol class="breadcrumb">
                    <li><a href="{% url "base:dashboard" %}">home</a></li>
                    <li><a href="{% url "analytics:view_case" case.id %}">caso</a></li>
                    <li class="active">resultados</li>
                </ol>
                <div class="panel-group" id="atms-accordion" role="tablist" aria-multiselectable="true">
                    {% for atm in atms %}
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="heading-{{ forloop.counter }}">
                                <h4 class="panel-title">
                                    {% with atm.atm_location.all|first as location %}
                                        <a role="button" data-toggle="collapse" data-parent="#atms-accordion"
                                           href="#atm-collapse-{{ forloop.counter }}"
                                           aria-expanded="true" aria-controls="atm-collapse-{{ forloop.counter }}">
                                            ATM {{ forloop.counter }} - {{ location.address }}
                                        </a>
                                    {% endwith %}
                                </h4>
                            </div>
                            <div id="atm-collapse-{{ forloop.counter }}" class="panel-collapse collapse in"
                                 role="tabpanel"
                                 aria-labelledby="heading-{{ forloop.counter }}">
                                <div class="panel-body">
                                    <svg id="atm-chart-{{ forloop.counter }}"
                                         style="width: 100%; height: 400px; margin: 0 auto"></svg>
                                    <div id="atm-timeline-{{ forloop.counter }}"
                                         style="min-width: 310px; margin: 0 auto"></div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block js %}
    {{ block.super }}
    <script type="text/javascript" src="{% static "data/fakeData.js" %}"></script>
    <script>
        $(function () {
            var chartsCount = Number("{{ atms.count }}"),
                    color = d3.scale.category20();

            for (var i = 0; i < chartsCount; i++) {
                // AREA CHART *****************************************************
                var chart = c3.generate({
                    bindto: '#atm-chart-' + (i + 1),
                    data: {
                        type: 'bar',
                        x: 'x',
                        columns: [
                            ['x', Date.UTC(2013, 5, 2), Date.UTC(2013, 5, 3), Date.UTC(2013, 5, 4), Date.UTC(2013, 5, 5), Date.UTC(2013, 5, 6), Date.UTC(2013, 5, 7)],
                            ['data1', 30, 200, 100, 400, 150, 250],
                            ['data2', 130, 340, 200, 500, 250, 350]
                        ]
                    },
                    axis: {
                        x: {
                            type: 'timeseries',
                            tick: {
                                format: '%Y-%m-%d'
                            }
                        }
                    }
                });

                // EVENTS GRAPH *****************************************************
                // create chart function
                var eventDropsChart = d3.chart.eventDrops()
                        .margin({top: 100, left: 100, bottom: 30, right: 100})
                        .eventLineColor(function (datum, index) {
                            return color(index);
                        })
                        .start(new Date(startTime))
                        .end(new Date(endTime));

                var $container = $('#atm-timeline-' + (i + 1));
                $container.height((eventsData.length * 55) + 'px');

                var svg = d3.select('#atm-timeline-' + (i + 1)).append("svg")
                        .attr("width", '100%')
                        .attr("height", '100%')
                        .datum(eventsData);
                // draw the chart
                eventDropsChart(svg);
            }
        })
    </script>
{% endblock %}
