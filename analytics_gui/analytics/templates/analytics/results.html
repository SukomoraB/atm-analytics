{% extends "base/base.html" %}
{% load staticfiles %}

{% block css %}
    {{ block.super }}
    <style>
        .zoom {
            fill: transparent;
            cursor: pointer;
        }

        .y-axis g line {
            stroke: grey;
            fill: none;
            stroke-width: 1px;
        }

        .graph-body .line {
            height: 20px;
            padding: 10px;
        }
    </style>
{% endblock %}


{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <ol class="breadcrumb">
                    <li><a href="{% url "analytics:dashboard" %}">home</a></li>
                    <li><a href="{% url "analytics:view_case" case.id %}">caso</a></li>
                    <li class="active">resultados</li>
                </ol>
                <div class="panel-group" id="atms-accordion" role="tablist" aria-multiselectable="true">
                    {% for atm in atms %}
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="heading-{{ forloop.counter }}">
                                <h4 class="panel-title">
                                    {% with atm.atm_location.all|first as location %}
                                        <a role="button" data-toggle="collapse" data-parent="#atms-accordion"
                                           href="#atm-collapse-{{ forloop.counter }}"
                                           aria-expanded="true" aria-controls="atm-collapse-{{ forloop.counter }}">
                                            ATM {{ forloop.counter }} - {{ location.address }}
                                        </a>
                                    {% endwith %}
                                </h4>
                            </div>
                            <div id="atm-collapse-{{ forloop.counter }}" class="panel-collapse collapse in"
                                 role="tabpanel"
                                 aria-labelledby="heading-{{ forloop.counter }}">
                                <div class="panel-body">
                                    <div id="atm-chart-{{ forloop.counter }}"
                                         style="min-width: 310px; height: 400px; margin: 0 auto"></div>
                                    <div id="atm-timeline-{{ forloop.counter }}"
                                         style="min-width: 310px; margin: 0 auto"></div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block js %}
    {{ block.super }}
    <script type="text/javascript" src="{% static "data/fakeData.js" %}"></script>
    <script>
        $(function () {
            var chartsCount = Number("{{ atms.count }}"),
                    color = d3.scale.category20(),
                    chartOptions = {
                        chart: {zoomType: 'x'},
                        title: {text: '', style: {display: 'none'}},
                        subtitle: {text: '', style: {display: 'none'}},
                        xAxis: {type: 'datetime'},
                        yAxis: {title: {text: 'Incidentes'}},
                        legend: {enabled: false},
                        plotOptions: {
                            area: {
                                fillColor: {
                                    linearGradient: {x1: 0, y1: 0, x2: 0, y2: 1},
                                    stops: [
                                        [0, Highcharts.getOptions().colors[0]],
                                        [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                                    ]
                                },
                                marker: {radius: 2},
                                lineWidth: 1,
                                states: {hover: {lineWidth: 1}},
                                threshold: null
                            }
                        }
                    };

            for (var i = 0; i < chartsCount; i++) {
                // AREA CHART *****************************************************
                chartOptions = _.extend(chartOptions, {
                    series: [{
                        type: 'area',
                        name: 'USD to EUR',
                        data: areaData
                    }]
                });
                $('#atm-chart-' + (i + 1)).highcharts(chartOptions);
                // EVENTS GRAPH *****************************************************
                // create chart function
                var eventDropsChart = d3.chart.eventDrops()
                        .margin({top: 100, left: 100, bottom: 30, right: 100})
                        .eventLineColor(function (datum, index) {
                            return color(index);
                        })
                        .start(new Date(startTime))
                        .end(new Date(endTime));

                console.log();

                var $container = $('#atm-timeline-' + (i + 1));
                $container.height((eventsData.length * 55) + 'px');

                var svg = d3.select('#atm-timeline-' + (i + 1)).append("svg")
                        .attr("width", '100%')
                        .attr("height", '100%')
                        .datum(eventsData);
                // draw the chart
                eventDropsChart(svg);
            }
        })
    </script>
{% endblock %}
