{% extends "base/base.html" %}
{% load i18n %}
{% load staticfiles %}
{% load bootstrap %}
{% load json_filters %}

{% block css %}
    {{ block.super }}
    <style>
        #amount-report-chart .x.axis text {
            text-anchor: end !important;
            transform: rotate(-45deg);
        }

        .percent-result {
            font-size: 27px;
            text-align: center;
        }

        .dynamic-analysis {
            background-color: #00A9FF;
            color: white;
        }

        .vis-item.green {
            background-color: {{ COLORS.GREEN }};
            border-color: {{ COLORS.GREEN }};
        }

        .vis-item.orange {
            background-color: {{ COLORS.ORANGE }};
            border-color: {{ COLORS.ORANGE }};
        }

        .vis-item.red {
            background-color: {{ COLORS.RED }};
            border-color: {{ COLORS.RED }};
        }

        .vis-item.window-event {
            background-color: {{ COLORS.BLUE }};
            border-color: {{ COLORS.BLUE }};
            color: white;
        }

        .vis-item.reposition-event {
            background-color: {{ COLORS.YELLOW }};
            border-color: #000000;
        }
    </style>
{% endblock %}


{% block content %}
    <div class="container">
        <div id="wait"></div>
        <div class="row">
            <div class="col-md-12">
                <ol class="breadcrumb">
                    <li><a href="{% url "base:dashboard" %}">{% trans "home" %}</a></li>
                    <li><a href="{% url "analytics:view_case" case.id %}">{% trans "case" %}</a></li>
                    <li class="active">{% trans "results" %}</li>
                </ol>

                <h3>
                    {% trans "Report" %}
                            <span class="pull-right">
                                {% trans "case status" %}
                                <span class="label label-{% if case.status == case.STATUS_OPEN %}success{% else %}danger{% endif %}">{{ case.get_status_display }}</span>
                            </span>
                </h3>
                <hr>
                <form method="post" action="" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-xs-12">
                            <div class='dc-data-count'>
                                <span class='filter-count'></span>
                                {% trans "selected out of" %} <span class='total-count'></span> {% trans "records" %}.
                            </div>
                        </div>
                        <div class="col-md-6 col-xs-12" id='atm-index-chart' style="">
                            <h4>{% trans "ATMs" %}
                                <span>
                                    <a class="reset"
                                       href="javascript:atmIndexChart.filterAll();dc.redrawAll();dc.refocusAll();"
                                       style="display: none;">
                                        {% trans "reset" %}
                                    </a>
                                </span>
                            </h4>
                        </div>

                        <div class="col-md-6 col-xs-12" id='total-operations-report-chart' style="height: 250px">
                            <h4>{% trans "Type of errors" %}
                                <span>
                                    <a class="reset"
                                       href="javascript:errorsReportChart.filterAll();dc.redrawAll();dc.refocusAll();"
                                       style="display: none;">
                                        {% trans "reset" %}
                                    </a>
                                </span>
                            </h4>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-4 col-xs-12">
                            <h4>{% trans "Critical errors" %}</h4>
                            <svg id="critical-errors-chart"
                                 style="width: 100%; height: 240px; margin: 0 auto"></svg>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h4>{% trans "Important errors" %}</h4>
                            <svg id="important-errors-chart"
                                 style="width: 100%; height: 240px; margin: 0 auto"></svg>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h4>{% trans "Transactions without problems" %}</h4>
                            <svg id="no-errors-chart" style="width: 100%; height: 240px; margin: 0 auto"></svg>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div id="operations-report-chart" style="width:100%; height: 300px; margin: 0 auto 25px">
                            <h4>{% trans "Operations report" %}
                                <span>
                                    <a class="reset"
                                       href="javascript:operationsReportChart.filterAll();dc.redrawAll();dc.refocusAll();"
                                       style="display: none;">
                                        {% trans "reset" %}
                                    </a>
                                </span>
                            </h4>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div id="errors-report-chart" style="width:100%; height: 300px; margin: 0 auto 35px">
                            <h4>{% trans "Errors" %}
                                <span>
                                    <a class="reset"
                                       href="javascript:totalOperationsReportChart.filterAll();dc.redrawAll();dc.refocusAll();"
                                       style="display: none;">
                                        {% trans "reset" %}
                                    </a>
                                </span>
                            </h4>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div id="amount-report-chart" style="width:100%; height: 300px; margin: 0 auto 20px">
                            <h4>{% trans "Amounts" %}
                                <span>
                                    <a class="reset"
                                       href="javascript:amountReportChart.filterAll();dc.redrawAll();dc.refocusAll();"
                                       style="display: none;">
                                        {% trans "reset" %}
                                    </a>
                                </span>
                            </h4>
                        </div>
                    </div>
                    <hr>
                    <div class="panel panel-primary row">
                        <div class="panel-heading">
                            <h3 class="panel-title">{% trans "Operations" %}</h3>
                            <div class="pull-right">
                                <span class="clickable filter"
                                      data-toggle="tooltip"
                                      title="{% trans "Filter" %}"
                                      data-container="body">
                                    <i class="glyphicon glyphicon-filter"></i>
                                </span>
                            </div>
                        </div>
                        <div class="panel-body">
                            <input type="text" class="form-control" id="operations-table-filter"
                                   data-action="filter"
                                   data-filters="#operations-table" placeholder="{% trans "Filter operations" %}"/>
                        </div>
                        <table class="table table-hover" id="operations-table">
                            <thead>
                            <tr>
                                <th>{% trans "Selector" %}</th>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Error" %}</th>
                                <th>{% trans "Amount" %}</th>
                                <th>{% trans "ATMs number" %}</th>
                                <th>{% trans "Type" %}</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <hr>
                    <div class="row">
                        <h3>{% trans "Timeline" %}</h3>
                        <div class="form-inline">
                            <h4>{% trans "Journal events filters" %}</h4>
                            <div class="form-group">
                                <div class="btn-group text-center" data-toggle="buttons">
                                    <label class="btn btn-primary active">
                                        <input id="timeline-filter-critical-erros" type="checkbox" autocomplete="off"
                                               checked>{% trans "Critical error" %}
                                    </label>
                                    <label class="btn btn-primary active">
                                        <input id="timeline-filter-important-erros" type="checkbox" autocomplete="off"
                                               checked>{% trans "Important Error" %}
                                    </label>
                                    <label class="btn btn-primary active">
                                        <input id="timeline-filter-no-erros" type="checkbox" autocomplete="off" checked>
                                        {% trans "No errors" %}
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="input-group">
                                    <div class="input-group-addon"><span class="glyphicon glyphicon-calendar"
                                                                         aria-hidden="true"></span></div>
                                    <input size="23" type="text" id="timeline-calendar-picker" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <select id="timeline-filter-errors" class="form-control" multiple="multiple"
                                        style="width:100%">
                                    <option value="all" selected>{% trans "All" %}</option>
                                </select>
                            </div>
                            {% if meta.windows.are_there %}
                                <h4>{% trans "Windows event filters" %}</h4>
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon"><span class="glyphicon glyphicon-calendar"
                                                                             aria-hidden="true"></span></div>
                                        <input size="23" type="text" id="timeline-windows-event-calendar-picker"
                                               class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <select id="timeline-filter-windows-errors" class="form-control" multiple="multiple"
                                            style="width:100%">
                                        <option value="all" selected>{% trans "All" %}</option>
                                    </select>
                                </div>
                                <div class="btn-group text-center" data-toggle="buttons">
                                    <label class="btn btn-primary disabled">
                                        <input id="timeline-filter-windows-events" type="checkbox"
                                               autocomplete="off">{% trans "Windows events" %}
                                    </label>
                                </div>
                            {% endif %}
                            {% if meta.reposition.count > 0 %}
                                <h4>{% trans "Cash replenishment events filters" %}</h4>
                                <div class="form-group">
                                    <div class="btn-group text-center" data-toggle="buttons">
                                        <label class="btn btn-primary active">
                                            <input id="timeline-filter-replenishment-events" type="checkbox"
                                                   autocomplete="off"
                                                   checked>{% trans "Cash replenishment events" %}
                                        </label>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <br>
                        <div id="chart-events-timeline" style="width: 100%; margin: 0 auto"></div>
                    </div>
                    <hr>
                    <div class="panel panel-primary row">
                        <div class="panel-heading">
                            <h3 class="panel-title">{% trans "Timeline" %}</h3>
                            <div class="pull-right">
                                <span data-toggle="tooltip"
                                      title="{% trans "Filter" %}"
                                      data-container="body">
                                    <i class="glyphicon glyphicon-filter"></i>
                                </span>
                            </div>
                        </div>
                        <div class="panel-body">
                            <input type="text" class="form-control" id="timeline-table-filter"
                                   data-action="filter"
                                   data-filters="#timeline-table" placeholder="{% trans "timeline filter" %}"/>
                        </div>
                        <table class="table table-hover" id="timeline-table">
                            <thead>
                            <tr>
                                <th>{% trans "Selector" %}</th>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Error" %}</th>
                                <th>{% trans "Amount" %}</th>
                                <th>{% trans "ATMs number" %}</th>
                                <th>{% trans "Type" %}</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <hr>
                    <div class="row">
                        <h3>{% trans "Automatic analysis" %}</h3>
                        <h4>{% trans "XFS events" %}</h4>
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Number of transactions" %}</h5>
                            <div class="well percent-result">{{ meta.journal.transactions_number }}</div>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Total amount of valid transactions" %}</h5>
                            <div class="well percent-result">{{ meta.journal.amount.valid_transactions }} {{ case.pretty_currency }}</div>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Transactions with critical errors" %}</h5>
                            <div class="well percent-result">{{ meta.journal.errors.critics_number }}</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Total percentage of transactions with critical errors" %}</h5>
                            <div class="well percent-result">{{ meta.journal.errors.critics_number_percentage }}%
                            </div>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Total amount of transactions with critical errors" %}</h5>
                            <div class="well percent-result">{{ meta.journal.amount.critical_errors_transactions }} {{ case.pretty_currency }}</div>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Total amount of transactions with important errors" %}</h5>
                            <div class="well percent-result">{{ meta.journal.amount.important_errors_transactions }} {{ case.pretty_currency }}</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Timeline range" %}</h5>
                            <div id="timeline-dynamic-range-dates" class="well dynamic-analysis text-center"></div>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Missing amount analyzed in the timeline" %}</h5>
                            <div id="timeline-dynamic-missing-amount"
                                 class="well percent-result dynamic-analysis"></div>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Estimated cash missing in case" %}</h5>
                            <div class="well percent-result dynamic-analysis">{{ case.missing_amount }} {{ case.pretty_currency }}</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Percentage of critical errors identified as missing" %}</h5>
                            <div id="timeline-dynamic-critic-errors-vs-critic-errors"
                                 class="well percent-result dynamic-analysis"></div>
                        </div>
                    </div>
                    <div class="row">
                        <h4>{% trans "Microsoft EventViewer" %}</h4>
                        {% if meta.windows.are_there %}
                            <div class="col-md-4 col-xs-12">
                                <h5>{% trans "Total events" %}</h5>
                                <div class="well percent-result">{{ meta.windows.count }}</div>
                            </div>
                            <div class="col-md-4 col-xs-12">
                                <h5>{% trans "Total events shown in the timeline" %}</h5>
                                <div id="timeline-dynamic-number-windows-events"
                                     class="well percent-result"></div>
                            </div>
                            <div class="col-md-4 col-xs-12">
                                <h5>{% trans "Total events that can induce errors XFS" %}</h5>
                                <div class="well percent-result">{% trans "Undefined" %}</div>
                            </div>
                            <div class="col-md-4 col-xs-12">
                                <h5>{% trans "Percentage of total errors that induce errors XFS" %}</h5>
                                <div class="well percent-result">{% trans "Undefined" %}</div>
                            </div>
                        {% else %}
                            <div class="well text-center">{% trans "Not provided logs for analysis" %}</div>
                        {% endif %}
                    </div>
                    <div class="row">
                        <h4>{% trans "Cash replenishment events" %}</h4>
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Amount of total cash replenishment events" %}</h5>
                            <div class="well percent-result">{{ meta.reposition.count }}</div>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Amount of cash events involving the analyzed ATM addresses" %}</h5>
                            <div class="well percent-result">{% trans "Undefined" %}</div>
                        </div>
                        <div class="col-md-4 col-xs-12">
                            <h5>{% trans "Number of events in timeline which can induce malfunction" %}</h5>
                            <div class="well percent-result">{{ meta.reposition.close_events_count }}</div>
                        </div>
                    </div>
                    <div class="row">
                        <h4>{% trans "Estimating percentage of fault" %}
                            <a href="javascript: void (0)" data-toggle="popover"
                               data-placement="left" data-html="true"
                               data-trigger="focus" title="Title"
                               data-content="{% trans "Estimate based on events XFS" %}">
                                <i class="fa fa-question-circle"></i>
                            </a>
                        </h4>
                        <div class="col-md-3 col-xs-12">
                            <h5>{% trans "User" %}</h5>
                            <div class="well percent-result text-center">33%</div>
                        </div>
                        <div class="col-md-3 col-xs-12">
                            <h5>{% trans "Bank" %}</h5>
                            <div class="well percent-result text-center">30%</div>
                        </div>
                        <div class="col-md-3 col-xs-12">
                            <h5>{% trans "Maintenance or replacement company" %}</h5>
                            <div class="well percent-result text-center">27%</div>
                        </div>
                        <div class="col-md-3 col-xs-12">
                            <h5>{% trans "External" %}</h5>
                            <div class="well percent-result text-center">10%</div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <h3>{% trans "Case Analysis" %}</h3>
                        <p><b>{% trans "Name" %}:</b> {{ case.name }}</p>
                        <p><b>{% trans "ID" %}:</b> {{ case.id }}</p>
                        <p><b>{% trans "Missing amount" %}:</b> {{ case.missing_amount }}</p>
                        <p><b>{% trans "Number of affected ATMs" %}:</b> {{ case.atms.count }}</p>
                        <p><b>{% trans "Date" %}:</b> {{ case.created_date }}</p>
                        <p><b>{% trans "Client" %}:</b> {{ case.bank }}</p>
                        <p><b>{% trans "Resolution" %}:</b></p>
                        <div class="form-group {% if form.resolution.errors %}has-error{% endif %}">
                            {% if form.resolution.help_text %}
                                <span class="help-block">{{ form.resolution.help_text }}</span>
                            {% endif %}
                            {% if form.resolution.errors %}
                                <span class="help-block">{{ form.resolution.errors|join:"<br \>" }}</span>
                            {% endif %}
                            {{ form.resolution|add_class:"form-control" }}
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="form-group">
                            {% if case.status == case.STATUS_OPEN %}
                                <input class="btn btn-default btn-lg pull-left" name="close-status"
                                       type="submit"
                                       value="{% trans "Close" %}"/>
                            {% else %}
                                <input class="btn btn-default btn-lg pull-left" name="open-status" type="submit"
                                       value="{% trans "Open" %}"/>
                            {% endif %}

                            <input class="btn btn-default btn-lg pull-right" name="save" type="submit"
                                   value="{% trans "Save" %}" style="margin-left: 20px"/>
                            <a id="generate-pdf" href="javascript: void(0)"
                               class="btn btn-default btn-lg pull-right">{% trans "PDF" %}</a>
                            <br>
                            <br>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>
{% endblock content %}

{% block js %}
    {{ block.super }}
    <script>
        $(function () {
            // init popover (help text)
            $("[data-toggle=popover]").popover();

            var traces =
            {{ traces | jsonify }}
            var journalData = traces.journal;
            var meta = {{ meta | jsonify }};
            var transformed = {};

            meta.journal.errors.names = _.map(meta.journal.errors.names, function (item) {
                return {id: item, text: item};
            });

            var dataCount = dc.dataCount('.dc-data-count');
            atmIndexChart = dc.pieChart("#atm-index-chart");
            errorsReportChart = dc.pieChart("#errors-report-chart");
            var criticalErrorsChart = dc.barChart("#critical-errors-chart");
            var importantErrorsChart = dc.barChart("#important-errors-chart");
            var noErrorsChart = dc.barChart("#no-errors-chart");
            operationsReportChart = dc.barChart("#operations-report-chart");
            totalOperationsReportChart = dc.pieChart("#total-operations-report-chart");
            amountReportChart = dc.barChart("#amount-report-chart");
            var dataTable = dc.dataTable("#operations-table");

            var dtgFormat = d3.time.format("%d/%m/%Y %H:%M:%S");
            var dtgFormat2 = d3.time.format("%Y-%m-%d %H:%M:%S");

            _.map(journalData, function (d) {
                d.date = dtgFormat.parse(d.date);
                d.start = d.date;
                d.content = d.has_errors ? d.error : 'No errors';
                transformed[d.date] = d;
            });

            // CROSSFILTER ******************************************************
            var ndx = crossfilter(journalData);
            var all = ndx.groupAll();

            // Dimensions and groups
            var atmsDim = ndx.dimension(function (d) {
                return "ATM " + (d.atm_index + 1);
            });
            var typeDim = ndx.dimension(function (d) {
                return d.event_type;
            });
            var errorsDim = ndx.dimension(function (d) {
                return d.error;
            });
            var amountDim = ndx.dimension(function (d) {
                return d.amount;
            });
            var dateDim = ndx.dimension(function (d) {
                return d.date;
            });
            // range for x axis. Get the min and max date value in data
            var minDate = dateDim.bottom(1)[0].date;
            var maxDate = dateDim.top(1)[0].date;

            var countATMsIndex = atmsDim.group().reduceCount(function (d) {
                return d.atm_index;
            });
            var typeErrorsGroupCount = typeDim.group().reduceCount(function (d) {
                return d;
            });
            var criticalErrors = dateDim.group().reduceSum(function (d) {
                if (d.color == "{{ COLORS.RED }}") {
                    return 1;
                }
            });
            var importantErrors = dateDim.group().reduceSum(function (d) {
                if (d.color == "{{ COLORS.ORANGE }}") {
                    return 1;
                }
            });
            var noErrors = dateDim.group().reduceSum(function (d) {
                if (d.color == "{{ COLORS.GREEN }}") {
                    return 1;
                }
            });
            var errorsCount = dateDim.group().reduceCount(function (d) {
                return d;
            });

            var errorsGroupCount = errorsDim.group().reduceCount(function (d) {
                return d;
            });

            var amountGroupCount = amountDim.group().reduceCount(function (d) {
                return d;
            });

            // TABLES *****************************************************
            var operationTable = $("#operations-table").DataTable({
                "columns": [
                    {"width": "20px"},
                    null,
                    null,
                    {"width": "100px"},
                    {"width": "20px"},
                    null]
            });
            $('#operations-table-filter').keyup(function () {
                operationTable.search($(this).val()).draw();
            });

            var timelineTable = $("#timeline-table").DataTable({
                "columns": [
                    {"width": "20px"},
                    null,
                    null,
                    {"width": "100px"},
                    {"width": "20px"},
                    null]
            });

            $('#timeline-table-filter').keyup(function () {
                operationTable.search($(this).val()).draw();
            });

            // CHARTS ***********************************************************
            // TIMELINE *********************************************************
            window.windowsEventsData = [];
            window.repositionData = traces.reposition;

            _.map(window.repositionData, function (d) {
                d.date = dtgFormat2.parse(d.date);
                d.start = d.date;
                d.content = d.address;
                d.event_type = "RepositionEvent";
                d.className = "reposition-event";
            });

            window.timelineData = journalData.concat(window.repositionData);

            function fillTimelineTableAndDynamicFields(items) {
                timelineTable.clear();
                var missingAmount = 0;
                var numberOfCriticErrors = 0;
                var numberOfWindowsEvents = 0;
                _.each(items, function (item) {
                    timelineTable.row.add([
                        "<input type='checkbox'></td>",
                        moment(item.date).format("ddd MMM DD YYYY HH:mm:ss [GTM]ZZ"),
                        item.error ? item.error : item.content,
                        item.amount ? item.amount + " " + "{{ case.pretty_currency }}" : "Does not apply",
                        item.atm_index + 1 ? item.atm_index + 1 : "Does not apply",
                        item.event_type ? item.event_type : "Does not apply"
                    ]);

                    missingAmount += item.amount ? item.amount : 0;
                    if (item.color == "{{ COLORS.RED }}") {
                        numberOfCriticErrors += 1;
                    }
                    if (item.event_type == "WindowsEventViewer") {
                        numberOfWindowsEvents += 1;
                    }
                });
                timelineTable.draw();
                var start = moment(timeline.getWindow().start);
                var end = moment(timeline.getWindow().end);
                $("#timeline-dynamic-range-dates").html(start.format("ddd MMM DD YYYY HH:mm:ss [GTM]ZZ") + "<br>" + end.format("ddd MMM DD YYYY HH:mm:ss [GTM]ZZ"));
                $("#timeline-dynamic-missing-amount").html(missingAmount + " " + "{{ case.pretty_currency }}");
                $("#timeline-dynamic-critic-errors-vs-critic-errors").html((numberOfCriticErrors * 100 / meta.journal.errors.critics_number).toFixed(2) + "%");

                $("#timeline-dynamic-number-windows-events").html(numberOfWindowsEvents);
            }

            var timelineContainer = document.getElementById('chart-events-timeline');
            var options = {};

            window.timeline = new vis.Timeline(timelineContainer, window.timelineData, options);
            fillTimelineTableAndDynamicFields(window.timelineData);
            window.timeline.fit();
            window.timeline.on("rangechanged", function (properties) {
                var tableData = [];
                var items = window.timelineData.concat(window.windowsEventsData);
                _.each(this.getVisibleItems(), function (id) {
                    var itemID = _.filter(items, function (item) {
                        return item.id == id;
                    });
                    tableData.push(itemID[0]);
                });
                fillTimelineTableAndDynamicFields(_.sortBy(tableData, 'date'));
            });

            function filterTimeline() {
                var itemsJournal = window.timelineData;

                var startDate = $('#timeline-calendar-picker').data('daterangepicker').startDate._d;
                var endDate = $('#timeline-calendar-picker').data('daterangepicker').endDate._d;

                // filter dates
                itemsJournal = _.filter(itemsJournal, function (item) {
                    return item.date >= startDate && item.date <= endDate;
                });

                // filter by errors
                var selectedErrors = $("#timeline-filter-errors").val();
                if (selectedErrors == null || selectedErrors.length == 0) {
                    $("#timeline-filter-errors").val(["all"]).change();
                } else if (selectedErrors[0] != "all") {
                    itemsJournal = _.filter(itemsJournal, function (item) {
                        return _.contains(selectedErrors, item.error);
                    });
                }

                // filter critical errors
                if (!$("#timeline-filter-critical-erros").is(":checked")) {
                    itemsJournal = _.filter(itemsJournal, function (item) {
                        return item.color != "{{ COLORS.RED }}";
                    });
                }

                // filter important errors
                if (!$("#timeline-filter-important-erros").is(":checked")) {
                    itemsJournal = _.filter(itemsJournal, function (item) {
                        return item.color != "{{ COLORS.ORANGE }}";
                    });
                }

                // filter no errors
                if (!$("#timeline-filter-no-erros").is(":checked")) {
                    itemsJournal = _.filter(itemsJournal, function (item) {
                        return item.color != "{{ COLORS.GREEN }}";
                    });
                }

                var itemsWindows = window.windowsEventsData;

                // filter windows by errors
                var selectedWindowsErrors = $("#timeline-filter-windows-errors").val();
                if (selectedWindowsErrors == null || selectedWindowsErrors.length == 0 || itemsWindows.length == 0) {
                    $("#timeline-filter-windows-errors").val(["all"]).change();
                } else if (selectedWindowsErrors[0] != "all") {
                    itemsWindows = _.filter(itemsWindows, function (item) {
                        return _.contains(selectedWindowsErrors, item.eventId);
                    });
                }

                // filter all windows errors
                if (!$("#timeline-filter-windows-events").is(":checked")) {
                    itemsWindows = _.filter(itemsWindows, function (item) {
                        return item.event_type != "WindowsEventViewer";
                    });
                }

                var itemsReposition = window.repositionData;

                // filter replenishment events
                if (!$("#timeline-filter-replenishment-events").is(":checked")) {
                    itemsReposition = _.filter(itemsReposition, function (item) {
                        return item.event_type != "RepositionEvent";
                    });
                }

                var items = itemsJournal.concat(itemsWindows);
                items = items.concat(itemsReposition);

                window.timeline.setItems(items);
                window.timeline.fit();
                fillTimelineTableAndDynamicFields(items);
            }

            // init timeline calendar
            $("#timeline-calendar-picker").daterangepicker({
                "timePicker": true,
                "timePicker24Hour": true,
                "timePickerSeconds": true,
                "locale": {
                    "format": "DD/MM/YYYY",
                    "separator": " / "
                },
                "alwaysShowCalendars": true,
                "startDate": minDate,
                "endDate": maxDate,
                "minDate": minDate,
                "maxDate": maxDate
            }, function (start, end, label) {
                filterTimeline()
            });

            if (meta.windows.are_there) {
                $("#timeline-windows-event-calendar-picker").daterangepicker({
                    "timePicker": true,
                    "timePicker24Hour": true,
                    "timePickerSeconds": true,
                    "locale": {
                        "format": "DD/MM/YYYY",
                        "separator": " / "
                    },
                    "alwaysShowCalendars": true,
                    "minDate": meta.windows.min_date,
                    "maxDate": meta.windows.max_date,
                    "startDate": meta.windows.min_date,
                    "endDate": meta.windows.max_date
                }, function (start, end, label) {
                    $.ajax({
                                method: "POST",
                                data: {
                                    csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
                                    event_start_date_timeline: start.toJSON(),
                                    event_end_date_timeline: end.toJSON()
                                }
                            })
                            .done(function (windowsEventsData) {
                                _.map(windowsEventsData, function (d) {
                                    d.date = dtgFormat2.parse(d.date);
                                    d.start = d.date;
                                    d.content = d.eventId;
                                    d.event_type = "WindowsEventViewer";
                                });
                                window.windowsEventsData = windowsEventsData;
                                $("#timeline-filter-windows-events").parent().removeClass("disabled").addClass("active");
                                $("#timeline-filter-windows-events").prop('checked', true);
                                filterTimeline();
                            });
                });
            }

            // init errors filter
            // xfs events
            $("#timeline-filter-errors").select2({
                data: meta.journal.errors.names,
                width: 'element'
            });
            $("#timeline-filter-errors").change(function (evt) {
                if ($("#timeline-filter-errors").val() != "all") {
                    filterTimeline();
                }
            });
            $("#timeline-filter-errors").on("select2:select", function (evt) {
                var selectedErrors = $("#timeline-filter-errors").val();
                if (selectedErrors.length > 0) {
                    if (evt.params.data.id != "all" && selectedErrors[0] == "all") {
                        $("#timeline-filter-errors").val(selectedErrors.slice(1, selectedErrors.length)).change();
                    } else if (evt.params.data.id == "all") {
                        $("#timeline-filter-errors").val(["all"]).change();
                    }
                }
            });
            $("#timeline-filter-critical-erros").change(function (evt) {
                filterTimeline();
            });
            $("#timeline-filter-important-erros").change(function (evt) {
                filterTimeline();
            });
            $("#timeline-filter-no-erros").change(function (evt) {
                filterTimeline();
            });
            // windows events
            $("#timeline-filter-windows-errors").select2({
                data: meta.windows.keys,
                width: '100%'
            });
            $("#timeline-filter-windows-errors").change(function (evt) {
                if ($("#timeline-filter-windows-errors").val() != "all") {
                    filterTimeline();
                }
            });
            $("#timeline-filter-windows-errors").on("select2:select", function (evt) {
                var selectedErrors = $("#timeline-filter-windows-errors").val();
                if (selectedErrors.length > 0) {
                    if (evt.params.data.id != "all" && selectedErrors[0] == "all") {
                        $("#timeline-filter-windows-errors").val(selectedErrors.slice(1, selectedErrors.length)).change();
                    } else if (evt.params.data.id == "all") {
                        $("#timeline-filter-windows-errors").val(["all"]).change();
                    }
                }
            });
            $("#timeline-filter-windows-events").change(function (evt) {
                filterTimeline();
            });
            // cash replaiments events
            if (meta.reposition.count > 0) {
                $("#timeline-filter-replenishment-events").change(function (evt) {
                    filterTimeline();
                });
            }

            // CROSSFILTER ******************************************************
            // DATA COUNT
            dataCount
                    .dimension(ndx)
                    .group(all)
                    .html({
                        some: '<strong>%filter-count</strong> selected out of <strong>%total-count</strong> records' +
                        ' | <a href=\'javascript:dc.filterAll(); dc.renderAll();\'\'>Reset All</a>',
                        all: 'All records selected. Please click on the graph to apply filters.'
                    });

            // PIE CHARTS ROW ---------------------- //
            atmIndexChart
                    .height(250)
                    .dimension(atmsDim)
                    .group(countATMsIndex)
                    .transitionDuration(100)
                    .legend(dc.legend())
                    .label(function (d) {
                        return (d.value / ndx.groupAll().reduceCount().value() * 100).toFixed(2) + "%";
                    });
            atmIndexChart.on("filtered", function (chart, filter) {
                window.timelineData = atmsDim.top(Infinity);
                var items = window.timelineData.concat(window.windowsEventsData);
                window.timeline.setItems(items);
                window.timeline.fit();
                fillTimelineTableAndDynamicFields(items);
                filterTimeline();
            });

            totalOperationsReportChart
                    .dimension(typeDim)
                    .group(typeErrorsGroupCount)
                    .innerRadius(30)
                    .transitionDuration(100)
                    .legend(dc.legend())
                    .label(function (d) {
                        return (d.value / ndx.groupAll().reduceCount().value() * 100).toFixed(2) + "%";
                    });
            totalOperationsReportChart.ordinalColors(["{{ COLORS.RED }}", "{{ COLORS.ORANGE }}", "{{ COLORS.GREEN }}"]);

            // BAR CHART FILTER BY TYPE ROW ---------------------- //
            criticalErrorsChart
                    .margins({top: 10, right: 10, bottom: 30, left: 50})
                    .dimension(dateDim)
                    .group(criticalErrors)
                    .mouseZoomable(true)
                    .brushOn(false)
                    .transitionDuration(100)
                    .centerBar(true)
                    .x(d3.time.scale().domain([minDate, maxDate]))
                    .elasticY(true)
                    .xAxis().tickFormat();
            criticalErrorsChart.on("renderlet", function (chart) {
                chart.selectAll('rect.bar').each(function (d) {
                    d3.select(this).attr("style", "fill: {{ COLORS.RED }}");
                });
            });

            importantErrorsChart
                    .margins({top: 10, right: 10, bottom: 30, left: 50})
                    .dimension(dateDim)
                    .group(importantErrors)
                    .mouseZoomable(true)
                    .brushOn(false)
                    .transitionDuration(100)
                    .centerBar(true)
                    .x(d3.time.scale().domain([minDate, maxDate]))
                    .elasticY(true)
                    .xAxis().tickFormat();
            importantErrorsChart.on("renderlet", function (chart) {
                chart.selectAll('rect.bar').each(function (d) {
                    d3.select(this).attr("style", "fill: {{ COLORS.ORANGE }}");
                });
            });

            noErrorsChart
                    .margins({top: 10, right: 10, bottom: 30, left: 50})
                    .dimension(dateDim)
                    .group(noErrors)
                    .mouseZoomable(true)
                    .brushOn(false)
                    .transitionDuration(100)
                    .centerBar(true)
                    .x(d3.time.scale().domain([minDate, maxDate]))
                    .elasticY(true)
                    .xAxis().tickFormat();
            noErrorsChart.on("renderlet", function (chart) {
                chart.selectAll('rect.bar').each(function (d) {
                    d3.select(this).attr("style", "fill: {{ COLORS.GREEN }}");
                });
            });

            // BAR CHART ALL TYPES ROW ---------------------- //
            operationsReportChart
                    .margins({top: 10, right: 10, bottom: 30, left: 50})
                    .dimension(dateDim)
                    .group(errorsCount)
                    .mouseZoomable(true)
                    .brushOn(false)
                    .elasticY(true)
                    .centerBar(true)
                    .transitionDuration(100)
                    .x(d3.time.scale().domain([minDate, maxDate]))
                    .xAxis().tickFormat();

            operationsReportChart
                    .colors(d3.scale.ordinal().domain(["red", "orange", "green"]).range(["{{ COLORS.RED }}", "{{ COLORS.ORANGE }}", "{{ COLORS.GREEN }}"]))
                    .colorAccessor(function (d) {
                        if (transformed[d.key].color == "{{ COLORS.RED }}") {
                            return "red"
                        } else if (transformed[d.key].color == "{{ COLORS.ORANGE }}") {
                            return "orange"
                        } else if (transformed[d.key].color == "{{ COLORS.GREEN }}") {
                            return "green"
                        }
                    });
            // we need to this helper function out of coordinateGridMixin
            function rangesEqual(range1, range2) {
                if (!range1 && !range2) {
                    return true;
                }
                else if (!range1 || !range2) {
                    return false;
                }
                else if (range1.length === 0 && range2.length === 0) {
                    return true;
                }
                else if (range1[0].valueOf() === range2[0].valueOf() &&
                        range1[1].valueOf() === range2[1].valueOf()) {
                    return true;
                }
                return false;
            }

            operationsReportChart.focusCharts = function (chartlist) {
                if (!arguments.length) {
                    return this._focusCharts;
                }
                this._focusCharts = chartlist; // only needed to support the getter above
                this.on('filtered', function (range_chart) {
                    if (!range_chart.filter()) {
                        dc.events.trigger(function () {
                            chartlist.forEach(function (focus_chart) {
                                focus_chart.x().domain(focus_chart.xOriginalDomain());
                            });
                        });
                    } else chartlist.forEach(function (focus_chart) {
                        if (!rangesEqual(range_chart.filter(), focus_chart.filter())) {
                            dc.events.trigger(function () {
                                focus_chart.focus(range_chart.filter());
                            });
                        }
                    });
                });
                return this;
            };
            operationsReportChart.focusCharts([criticalErrorsChart, importantErrorsChart, noErrorsChart]);

            // PIE CHART ERRORS ROW ---------------------- //
            errorsReportChart
                    .dimension(errorsDim)
                    .group(errorsGroupCount)
                    .renderLabel(false)
                    .legend(dc.legend());

            // PIE CHART AMOUNT ROW ---------------------- //
            amountReportChart
                    .dimension(amountDim)
                    .group(amountGroupCount)
                    .transitionDuration(100)
                    .outerPadding(0)
                    .gap(1)
                    .elasticY(true)
                    .x(d3.scale.ordinal())
                    .xUnits(dc.units.ordinal)
                    .renderHorizontalGridLines(true);

            // TABLE ------------------------------------- //
            dataTable
                    .dimension(dateDim)
                    .group(function (d) {
                        return ""
                    })
                    .showGroups(false)
                    .columns([
                        function (d) {
                            return '<input type="checkbox"></td>'
                        },
                        function (d) {
                            return moment(d.date).format("ddd MMM DD YYYY HH:mm:ss [GTM]ZZ");
                        },
                        function (d) {
                            return d.content;
                        },
                        function (d) {
                            return d.amount + " " + "{{ case.pretty_currency }}";
                        },
                        function (d) {
                            return d.atm_index + 1;
                        },
                        function (d) {
                            return d.event_type;
                        }
                    ])
                    .sortBy(function (d) {
                        return d.date;
                    })
                    .order(d3.ascending);

            dc.renderAll();
        })
    </script>
    <script type="text/javascript" src="{% static "js/rgbcolor.js" %}"></script>
    <script type="text/javascript" src="{% static "js/StackBlur.js" %}"></script>
    <script type="text/javascript" src="{% static "js/canvg.min.js" %}"></script>
    <script type="text/javascript" src="{% static "js/html2canvas.js" %}"></script>
    <script type="text/javascript" src="{% static "js/svgAsBase64.js" %}"></script>
    <script type="text/javascript" src="{% static "js/generatePdf.js" %}"></script>
{% endblock %}
